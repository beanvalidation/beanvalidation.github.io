<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta content="IE=Edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>
      Bean Validation - Validating elements contained in a container (like collections)
    </title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.13/semantic.css" media="screen" rel="stylesheet">
    <link href="/stylesheets/styles.css?t=1514926622" media="screen" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.1.1.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.13/semantic.js"></script>
    <!-- / Unfortunately, matchHeight doesn't follow the same convention as the other minified files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.matchHeight/0.7.2/jquery.matchHeight.js"></script>
    <link href="/news/news.atom" rel="alternate" type="application/atom+xml">
  </head>
  <body class="pushable">
    <div class="ui vertical menu inverted sidebar left print hidden" id="mobile-menu">
      <a class="item" href="/" title="Home">
        <i class="grid icon home"></i>
        Home
      </a>
      <a class="item" href="/news/">
        <i class="grid icon newspaper"></i>
        News
      </a>
      <a class="item" href="/2.0/">
        <i class="grid icon book"></i>
        <strong>Bean Validation 2.0</strong>
      </a>
      <div class="item">
        <i class="grid icon archive"></i>
        Archives
        <div class="menu">
          <a class="item" href="/1.1/">
            <i class="grid icon book"></i>
            Bean Validation 1.1
          </a>
          <a class="item" href="/1.0/">
            <i class="grid icon book"></i>
            Bean Validation 1.0
          </a>
        </div>
      </div>
      <a class="item" href="/resources/">
        <i class="grid icon folder open"></i>
        Additional resources
      </a>
      <a class="item" href="/licensing/">
        <i class="grid icon legal"></i>
        Licensing
      </a>
      <a class="item" href="/contribute/">
        <i class="grid icon users"></i>
        Contribute
      </a>
    </div>
    <div class="pusher">
      <div class="mobile-menu-button-bar mobile only print hidden">
        <a class="item" id="mobile-menu-toggle">
          <i class="sidebar icon"></i>
          Menu
        </a>
      </div>
      <header role="banner">
        <div class="ui container banner">
          <div class="ui stackable menu mobile hidden print hidden" id="nav">
            <a class="item" href="/" title="Home">
              <img alt="Bean Validation" src="/logo/logo.svg">
            </a>
            <a class="item" href="/news/">News</a>
            <a class="item" href="/2.0/">
              <strong>Bean Validation 2.0</strong>
            </a>
            <div class="dropdown item ui">
              Archives
              <i class="dropdown icon"></i>
              <div class="menu">
                <a class="item" href="/1.1/">Bean Validation 1.1</a>
                <a class="item" href="/1.0/">Bean Validation 1.0</a>
              </div>
            </div>
            <a class="item" href="/resources/">Resources</a>
            <a class="item" href="/licensing/">Licensing</a>
            <a class="item" href="/contribute/">Contribute</a>
          </div>
        </div>
      </header>
      <div class="jumbotron small">
        <div class="ui container">
          <h1>Bean Validation</h1>
          <h2>Validating elements contained in a container (like collections)</h2>
        </div>
      </div>
      <div class="ui container page-content">
        <div class="content" id="content">
          <div id="toc" class="toc">
          <div id="toctitle">Table of Contents</div>
          <ul class="sectlevel1">
          <li><a href="#problem">1. Problem</a></li>
          <li><a href="#proposition-1">2. Proposition 1</a>
          <ul class="sectlevel2">
          <li><a href="#containers">2.1. Containers</a></li>
          <li><a href="#constraints-applied-and-containers">2.2. Constraints applied and containers</a></li>
          <li><a href="#type-parameter-and-constraint-propagation">2.3. Type parameter and constraint propagation</a></li>
          <li><a href="#crazy-type-use">2.4. "Crazy" Type use</a></li>
          <li><a href="#drawbacks">2.5. Drawbacks</a></li>
          <li><a href="#naming-options">2.6. Naming options</a></li>
          <li><a href="#remaining-todos">2.7. Remaining TODOs</a></li>
          </ul>
          </li>
          <li><a href="#alternative-proposal-consider-type-constraints-as-instance-specific-amendment-of-constraint-set-gunnar">3. Alternative proposal: Consider type-constraints as instance-specific amendment of constraint set (Gunnar)</a>
          <ul class="sectlevel2">
          <li><a href="#motivation">3.1. Motivation</a></li>
          <li><a href="#constraints-of-collection-elements">3.2. Constraints of collection elements</a></li>
          <li><a href="#obtaining-values-from-containers">3.3. Obtaining values from containers</a></li>
          </ul>
          </li>
          <li><a href="#attic">4. Attic</a>
          <ul class="sectlevel2">
          <li><a href="#type-use-annotations-vs-enlisting-unwrapping-logic">4.1. Type use annotations vs enlisting unwrapping logic</a></li>
          <li><a href="#generic-mechanism-vs-special-cases">4.2. Generic mechanism vs special cases</a></li>
          <li><a href="#generic-container-notion">4.3. Generic container notion</a></li>
          </ul>
          </li>
          </ul>
          </div>
          <div id="preamble">
          <div class="sectionbody">
          <div class="paragraph">
          <p><a href="https://hibernate.atlassian.net/browse/BVAL-508">JIRA</a><br>
          <a href="https://hibernate.atlassian.net/browse/BVAL-499">Related JIRA</a><br>
          <a href="/glossary/">Java generics glossary</a></p>
          </div>
          </div>
          </div>
          <div class="sect1">
          <h2 id="problem"><a class="anchor" href="#problem"></a>1. Problem</h2>
          <div class="sectionbody">
          <div class="paragraph">
          <p>It is useful to be able to apply constraints on elements contained in a so called <em>container</em>.
          Examples of containers are:</p>
          </div>
          <div class="ulist">
          <ul>
          <li>
          <p><code>Collection</code></p>
          </li>
          <li>
          <p><code>Optional</code></p>
          </li>
          <li>
          <p>JavaFX&#8217;s <code>Property</code></p>
          </li>
          </ul>
          </div>
          <div class="paragraph">
          <p>But today the constraints are applied on the container value itself and not its content.</p>
          </div>
          </div>
          </div>
          <div class="sect1">
          <h2 id="proposition-1"><a class="anchor" href="#proposition-1"></a>2. Proposition 1</h2>
          <div class="sectionbody">
          <div class="sect2">
          <h3 id="containers"><a class="anchor" href="#containers"></a>2.1. Containers</h3>
          <div class="paragraph">
          <p>Bean Validation will offer the notion of container of values to validate.
          Containers can contain one value, or several values (<code>Optional</code> vs <code>Collection</code>).
          A container can contain several types of values: a <code>Map</code> contains keys and values for example.</p>
          </div>
          <div class="paragraph">
          <p>Extractors for the specific tuple container and value type can be implemented.</p>
          </div>
          <div class="paragraph">
          <p>We differentiate single and plural for two reasons:</p>
          </div>
          <div class="ulist">
          <ul>
          <li>
          <p>we could have different functional rules depending on the case</p>
          </li>
          <li>
          <p>it avoids the unnecessary instantiation of an <code>Iterator</code> in the singular case</p>
          </li>
          </ul>
          </div>
          <div class="admonitionblock note">
          <table>
          <tr>
          <td class="icon">
          <i class="fa icon-note" title="Note"></i>
          </td>
          <td class="content">
          <div class="title">On the differentiation of single and plural</div>
          <div class="paragraph">
          <p>Some fine the separation of single and plural an overhead.
          While Bean Validation design is very sensitive to performance waste in the hot spots,
          let&#8217;s re-discuss that point once we have a RI prototype and can do some tests.</p>
          </div>
          </td>
          </tr>
          </table>
          </div>
          <div class="listingblock">
          <div class="content">
          <pre class="CodeRay highlight"><code data-lang="java"><span style="color:#777">// Draft proposal for the contract</span>&#x000A;<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">interface</span> <span style="color:#B06;font-weight:bold">SingleContainerValueExtractor</span>&lt;CONTAINER,CONTAINED&gt; {&#x000A;    CONTAINED extractValue(CONTAINER container);&#x000A;}&#x000A;&#x000A;<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">interface</span> <span style="color:#B06;font-weight:bold">ManyContainerValuesExtractor</span>&lt;CONTAINER,CONTAINED&gt; {&#x000A;    <span style="color:#0a8;font-weight:bold">Iterable</span>&lt;CONTAINED&gt; extractValue(CONTAINER container);&#x000A;}&#x000A;&#x000A;<span style="color:#777">// Examples</span>&#x000A;&#x000A;<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">OptionalContainerExtractor</span>&lt;T&gt; <span style="color:#088;font-weight:bold">implements</span> SingleContainerValueExtractor&lt;Optional&lt;<span style="color:#007">@ExtractedValue</span> T&gt;,T&gt; {&#x000A;    T extractValue(Optional&lt;T&gt; optional) { ... };&#x000A;}</code></pre>
          </div>
          </div>
          <div class="quoteblock">
          <blockquote>
          <div class="paragraph">
          <p>GM: What&#8217;s the purpose of the CONTAINED parameter? Or put in another way, when would an extractor not implement it with another type parameter as you did here with <code>T</code>?</p>
          </div>
          </blockquote>
          </div>
          <div class="paragraph">
          <p>Bean Validation will have out of the box support for containers <code>Iterable</code>, <code>Map</code> and <code>Optional</code>.</p>
          </div>
          <div class="admonitionblock important">
          <table>
          <tr>
          <td class="icon">
          <i class="fa icon-important" title="Important"></i>
          </td>
          <td class="content">
          <div class="title">TODO</div>
          <div class="paragraph">
          <p>Any other Java SE type to consider?<br>
          Should we support JavaFX Property&lt;T&gt;?</p>
          </div>
          </td>
          </tr>
          </table>
          </div>
          <div class="paragraph">
          <p>Custom container extractors can be provided via:</p>
          </div>
          <div class="ulist">
          <ul>
          <li>
          <p>property describing the list of FQCN (in the XML configuration file for example)</p>
          </li>
          <li>
          <p>factory builder: offer an API to add extractor classes before building <code>ValidatorFactory</code></p>
          </li>
          <li>
          <p>service locator: use the SL pattern to find the enlistable extractors</p>
          </li>
          </ul>
          </div>
          <div class="admonitionblock important">
          <table>
          <tr>
          <td class="icon">
          <i class="fa icon-important" title="Important"></i>
          </td>
          <td class="content">
          TODO: refine how the container implementations are discovered.
          See <a href="http://docs.jboss.org/hibernate/validator/5.2/reference/en-US/html_single/#section-value-handling">Hibernate Validator&#8217;s feature</a>
          </td>
          </tr>
          </table>
          </div>
          <div class="sect3">
          <h4 id="when-are-containers-used"><a class="anchor" href="#when-are-containers-used"></a>2.1.1. When are containers used?</h4>
          <div class="paragraph">
          <p>When a property is of a known container, constraints declarations are explored.
          A typical example is a property using constraints on type parameters of <code>TYPE_USE</code> (<code>Collection&lt;@Size String&gt;</code>).</p>
          </div>
          <div class="paragraph">
          <p>If constraints are discovered, the unwrapping mechanism is used
          to read contained value(s) and potentially apply constraints on them (see below).</p>
          </div>
          <div class="paragraph">
          <p>Does that mean that if we find a type use constraint, there is no need for <code>@Valid</code>?</p>
          </div>
          <div class="ulist">
          <ul>
          <li>
          <p>that would allow us not to require <code>@Valid</code> for <code>Optional&lt;@NotNull String&gt;</code></p>
          </li>
          </ul>
          </div>
          <div class="quoteblock">
          <blockquote>
          <div class="paragraph">
          <p>GM: What about <code>Optional&lt;@NotNull PandaBear&gt;</code>? Should the presence of <code>@NotNull</code> alone trigger cascaded validation of the contained value? This doesn&#8217;t seem right to me.</p>
          </div>
          </blockquote>
          </div>
          <div class="ulist">
          <ul>
          <li>
          <p>when constraint annotations are present on the member or method declaration itself,
          we also enforce the use of containers (assuming the proper use of <code>@ConstraintsApplyTo</code>)</p>
          </li>
          </ul>
          </div>
          <div class="paragraph">
          <p>Containers of containers are applied recursively if necessary.</p>
          </div>
          <div class="admonitionblock important">
          <table>
          <tr>
          <td class="icon">
          <i class="fa icon-important" title="Important"></i>
          </td>
          <td class="content">
          <div class="title">TODO: infinite loops?</div>
          <div class="paragraph">
          <p>I don&#8217;t think there is an issue of infinite loop.
          At runtime, we can stop when we encounter the same container instance for the second time.
          This is how we do it in Bean Validation today.</p>
          </div>
          <div class="paragraph">
          <p>For the metadata build up, I don&#8217;t think we end up in an infinite loop.
          The container declarations remain written in the code and thus cannot infinitely loop.</p>
          </div>
          </td>
          </tr>
          </table>
          </div>
          </div>
          <div class="sect3">
          <h4 id="which-container-extractor-to-use"><a class="anchor" href="#which-container-extractor-to-use"></a>2.1.2. Which container extractor to use?</h4>
          <div class="paragraph">
          <p>An extractor is associated to a container type (e.g. <code>Collection</code>) and a value type (e.g. the element of the collection).
          For a given container + value type tuple,
          the extractor used is the one targeting the most specific container type that is a supertype of the container.
          Rules used are the same used by the constraint validator selection.</p>
          </div>
          <div class="admonitionblock important">
          <table>
          <tr>
          <td class="icon">
          <i class="fa icon-important" title="Important"></i>
          </td>
          <td class="content">
          TODO: handles interfaces?
          </td>
          </tr>
          </table>
          </div>
          <div class="paragraph">
          <p>Value type is the data type returned by the extractor, for example:</p>
          </div>
          <div class="ulist">
          <ul>
          <li>
          <p>the collection elements type</p>
          </li>
          <li>
          <p>the map keys type</p>
          </li>
          <li>
          <p>the map values type</p>
          </li>
          </ul>
          </div>
          <div class="paragraph">
          <p>Container type and value type are not discovered per instance but per declaration site: in other words, extractor usage can be computed statically (assuming the list of extractors known).</p>
          </div>
          <div class="paragraph">
          <p>Depending on where constraints are placed, they will be applied to one or the other value type.
          The following rules apply to link the constraints to the value type and thus the extractor.</p>
          </div>
          <div class="paragraph">
          <p>An extractor must annotate the type parameter it targets as value type with <code>@ExtractedValue</code>.</p>
          </div>
          <div class="listingblock">
          <div class="content">
          <pre class="CodeRay highlight"><code data-lang="java"><span style="color:#777">// extract the key of a map: constraints on map keys are thus applied</span>&#x000A;<span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">MapKeyExtractor</span>&lt;<span style="color:#0a8;font-weight:bold">Key</span>, Value&gt; <span style="color:#088;font-weight:bold">extends</span> ManyContainerValuesExtractor&lt;<span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#007">@ExtractedValue</span> <span style="color:#0a8;font-weight:bold">Key</span>, Value&gt;, <span style="color:#0a8;font-weight:bold">Key</span>&gt; {&#x000A;}</code></pre>
          </div>
          </div>
          <div class="paragraph">
          <p><code>@ExtractedValue</code> can point to a specific supertype type parameter</p>
          </div>
          <div class="listingblock">
          <div class="content">
          <pre class="CodeRay highlight"><code data-lang="java"><span style="color:#777">// declare List&lt;T&gt; as the type parameter targeted (index)</span>&#x000A;<span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">IntegerListExtractor</span> <span style="color:#088;font-weight:bold">extends</span> ManyContainerValuesExtractor&lt;<span style="color:#007">@ExtractedValue</span>(typeParameterHost=<span style="color:#0a8;font-weight:bold">List</span>.class, typeParameterIndex=<span style="color:#00D">0</span>) IntegerList, <span style="color:#0a8;font-weight:bold">Integer</span>&gt; {&#x000A;}&#x000A;&#x000A;<span style="color:#777">// declare List&lt;T&gt; as the type parameter targeted (name)</span>&#x000A;<span style="color:#777">// probably a bit brittle</span>&#x000A;<span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">IntegerList</span> <span style="color:#088;font-weight:bold">extends</span> ManyContainerValuesExtractor&lt;<span style="color:#007">@ExtractedValue</span>(typeParameterHost=<span style="color:#0a8;font-weight:bold">List</span>.class, typeParameterName=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">E</span><span style="color:#710">&quot;</span></span>) IntegerList, <span style="color:#0a8;font-weight:bold">Integer</span>&gt; {&#x000A;}</code></pre>
          </div>
          </div>
          <div class="paragraph">
          <p>Note that it is possible that there are no type parameter associated to the extractor.
          The constraints are hosted not on a type parameter but on the field or getter itself in conjunction with <code>@ConstraintsApplyTo(CONTAINED_VALUES)</code>.
          See next section for a detailed explanation of <code>@ConstraintsApplyTo</code>.</p>
          </div>
          <div class="listingblock">
          <div class="content">
          <pre class="CodeRay highlight"><code data-lang="java"><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">SomeContainer</span> { ... }&#x000A;&#x000A;<span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">ExamplePojo</span> {&#x000A;    <span style="color:#777">// constraint applies to what's inside SomeContainer</span>&#x000A;    <span style="color:#007">@NotNull</span> <span style="color:#007">@ConstraintsApplyTo</span>(CONTAINED_VALUE) SomeContainer foo;&#x000A;}&#x000A;&#x000A;<span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">SomeContainerExtractor</span> <span style="color:#088;font-weight:bold">extends</span> SingleContainerValueExtractor&lt;<span style="color:#007">@ExtractedValue</span> SomeContainer,Containee&gt; {&#x000A;    ...&#x000A;}</code></pre>
          </div>
          </div>
          <div class="paragraph">
          <p>In this case the type parameter is identified as an ad-hoc "no type parameter".</p>
          </div>
          <div class="paragraph">
          <p>We can also enhance the extractor contract to return a generic <code>Path</code> object representing how navigation from the container to the value type happens (or is represented).</p>
          </div>
          <div class="admonitionblock important">
          <table>
          <tr>
          <td class="icon">
          <i class="fa icon-important" title="Important"></i>
          </td>
          <td class="content">
          TODO: refine the <code>Path</code> approach:
          </td>
          </tr>
          </table>
          </div>
          <div class="ulist">
          <ul>
          <li>
          <p>Indexing of List or keys for Maps. Template?</p>
          </li>
          <li>
          <p>What <code>Kind</code> should nodes for type use constraints have? Should there be a new <code>Node.Kind</code>?</p>
          </li>
          </ul>
          </div>
          <div class="sect4">
          <h5 id="alternative-approach-extractors-returning-code-valueandpath-code"><a class="anchor" href="#alternative-approach-extractors-returning-code-valueandpath-code"></a>Alternative approach: extractors returning <code>ValueAndPath</code></h5>
          <div class="paragraph">
          <p>Gunnar proposes an alternative to the extractor.  This alternative provides:</p>
          </div>
          <div class="ulist">
          <ul>
          <li>
          <p>one extractor per container type (and not container + value type)</p>
          </li>
          <li>
          <p>the extractor selected is the one matching the most specific super type of the container</p>
          <div class="ulist">
          <ul>
          <li>
          <p>only one extractor is executed per container</p>
          </li>
          </ul>
          </div>
          </li>
          </ul>
          </div>
          <div class="listingblock">
          <div class="content">
          <pre class="CodeRay highlight"><code data-lang="java"><span style="color:#339;font-weight:bold">interface</span> <span style="color:#B06;font-weight:bold">SingleValueExtractor</span>&lt;I, O&gt; {&#x000A;&#x000A;    O extractValue(I input);&#x000A;&#x000A;    <span style="color:#777">// only invoked if invalid; Property name enough as input?</span>&#x000A;    <span style="color:#777">// do we even need any input?</span>&#x000A;    Path.Node getNode(<span style="color:#0a8;font-weight:bold">String</span> property);&#x000A;}&#x000A;&#x000A;<span style="color:#339;font-weight:bold">interface</span> <span style="color:#B06;font-weight:bold">MultiValueExtractor</span>&lt;I, O&gt; {&#x000A;&#x000A;    ValueAndNodeIterator&lt;O&gt; extractValues(I input);&#x000A;&#x000A;    <span style="color:#777">// should it extend Java Iterator?</span>&#x000A;    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">interface</span> <span style="color:#B06;font-weight:bold">ValueAndNodeIterator</span>&lt;O&gt; {&#x000A;&#x000A;        <span style="color:#339;font-weight:bold">boolean</span> hasNext();&#x000A;&#x000A;        O next();&#x000A;&#x000A;        <span style="color:#777">// Used to identify the location where constraints should be looked for</span>&#x000A;        <span style="color:#0a8;font-weight:bold">TypeVariable</span>&lt;?&gt; typeVariable();&#x000A;&#x000A;        <span style="color:#777">// only invoked if invalid; Property name enough as input?</span>&#x000A;        <span style="color:#777">// might need to be Path instead of Path.Node</span>&#x000A;        Path.Node getNode(<span style="color:#0a8;font-weight:bold">String</span> property);&#x000A;    }&#x000A;}&#x000A;&#x000A;<span style="color:#777">// implementation example</span>&#x000A;<span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">MapExtractor</span> <span style="color:#088;font-weight:bold">implements</span> MultiValueExtractor&lt;<span style="color:#0a8;font-weight:bold">Map</span>, <span style="color:#0a8;font-weight:bold">Object</span>&gt; {&#x000A;&#x000A;    <span style="color:#088;font-weight:bold">public</span> ValueAndNodeIterator&lt;<span style="color:#0a8;font-weight:bold">Object</span>&gt; extractValues(<span style="color:#0a8;font-weight:bold">Map</span> input) {&#x000A;        <span style="color:#0a8;font-weight:bold">Set</span>&lt;<span style="color:#0a8;font-weight:bold">Map</span>.Entry&lt;?, ?&gt;&gt; entrySet = input.entrySet();&#x000A;        <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">Iterator</span>&lt;<span style="color:#0a8;font-weight:bold">Map</span>.Entry&gt; iterator = input.entrySet().iterator();&#x000A;        <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">TypeVariable</span>&lt;<span style="color:#0a8;font-weight:bold">Class</span>&lt;<span style="color:#0a8;font-weight:bold">Map</span>&gt;&gt; k = <span style="color:#0a8;font-weight:bold">Map</span>.class.getTypeParameters()[<span style="color:#00D">0</span>];&#x000A;        <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">TypeVariable</span>&lt;<span style="color:#0a8;font-weight:bold">Class</span>&lt;<span style="color:#0a8;font-weight:bold">Map</span>&gt;&gt; v = <span style="color:#0a8;font-weight:bold">Map</span>.class.getTypeParameters()[<span style="color:#00D">1</span>];&#x000A;&#x000A;        <span style="color:#777">// returns alternatively key and value for each map entry</span>&#x000A;        <span style="color:#080;font-weight:bold">return</span> <span style="color:#080;font-weight:bold">new</span> ValueAndNodeIterator&lt;<span style="color:#0a8;font-weight:bold">Object</span>&gt;() {&#x000A;&#x000A;            <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">boolean</span> atKey = <span style="color:#069">true</span>;&#x000A;            <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">Map</span>.Entry&lt;?, ?&gt; current;&#x000A;&#x000A;            <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">boolean</span> hasNext() {&#x000A;                <span style="color:#080;font-weight:bold">return</span> iterator.hasNext();&#x000A;            }&#x000A;&#x000A;            <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">Object</span> next() {&#x000A;                <span style="color:#080;font-weight:bold">if</span> ( atKey ) {&#x000A;                    current = iterator.next();&#x000A;                    atKey = <span style="color:#069">false</span>;&#x000A;                    <span style="color:#080;font-weight:bold">return</span> current.getKey();&#x000A;                }&#x000A;                <span style="color:#080;font-weight:bold">else</span> {&#x000A;                    atKey = <span style="color:#069">true</span>;&#x000A;                    <span style="color:#080;font-weight:bold">return</span> current.getValue();&#x000A;                }&#x000A;            }&#x000A;&#x000A;            <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">TypeVariable</span>&lt;?&gt; typeVariable() {&#x000A;                <span style="color:#080;font-weight:bold">return</span> atKey ? k : v;&#x000A;            }&#x000A;&#x000A;            <span style="color:#088;font-weight:bold">public</span> Node getNode(<span style="color:#0a8;font-weight:bold">String</span> property) {&#x000A;                <span style="color:#777">// TODO Auto-generated method stub</span>&#x000A;                <span style="color:#080;font-weight:bold">return</span> <span style="color:#069">null</span>;&#x000A;            }&#x000A;        };&#x000A;    }&#x000A;}</code></pre>
          </div>
          </div>
          <div class="paragraph">
          <p>In this approach, a container offering multiple value types (like <code>Map</code>) will have a unique extractor.
          This extractor will return (an iterator of) the values and offer the ability to compute the <code>Path.Node</code>
          and retrieve the <code>TypeVariable</code>.
          For example the map extractor will return <code>2n</code> elements (for a map of <code>n</code>).</p>
          </div>
          <div class="paragraph">
          <p>The <code>TypeVariable</code> is used to know which type parameter this value corresponds to.
          Constraints will be looked on this type parameter - whether on the class itself or its subclasses.</p>
          </div>
          <div class="paragraph">
          <p>Open questions and limitations:</p>
          </div>
          <div class="ulist">
          <ul>
          <li>
          <p>is <code>TypeVariable</code> both enough and necessary to express the type parameter targeted?</p>
          <div class="ulist">
          <ul>
          <li>
          <p>an alternative is to provide an object containing the same info as <code>@ExtractedValue</code>: parameter host and parameter index</p>
          </li>
          <li>
          <p>At first sight, <code>TypeVariable</code> does not provide the parameter host information</p>
          </li>
          </ul>
          </div>
          </li>
          <li>
          <p>this model makes extractor resolution simpler as a single extractor is present per container</p>
          </li>
          <li>
          <p>but it does not allow extractor composition</p>
          <div class="ulist">
          <ul>
          <li>
          <p>a subclass of Collection with special extracting demands will need to reimplement the regular collection extraction logic as well as its custom one in one class</p>
          </li>
          </ul>
          </div>
          </li>
          </ul>
          </div>
          </div>
          </div>
          </div>
          <div class="sect2">
          <h3 id="constraints-applied-and-containers"><a class="anchor" href="#constraints-applied-and-containers"></a>2.2. Constraints applied and containers</h3>
          <div class="paragraph">
          <p>Constraints declared on the type parameter of a type use will be applied to the contained value
          as extracted by the container logic.</p>
          </div>
          <div class="listingblock">
          <div class="content">
          <pre class="CodeRay highlight"><code data-lang="java"><span style="color:#777">// each String of the collection is validated for the regexp</span>&#x000A;<span style="color:#0a8;font-weight:bold">Set</span>&lt;<span style="color:#007">@Pattern</span>(...) <span style="color:#0a8;font-weight:bold">String</span>&gt; emails;</code></pre>
          </div>
          </div>
          <div class="paragraph">
          <p>By default, constraints declared on the container will apply to the container.
          This ensures backward compatibility.</p>
          </div>
          <div class="listingblock">
          <div class="content">
          <pre class="CodeRay highlight"><code data-lang="java"><span style="color:#777">// @Size is applied on the collection</span>&#x000A;<span style="color:#007">@Size</span>(min=<span style="color:#00D">5</span>) <span style="color:#0a8;font-weight:bold">List</span>&lt;<span style="color:#0a8;font-weight:bold">Integer</span>&gt; ages;</code></pre>
          </div>
          </div>
          <div class="paragraph">
          <p>Extractors can specify that constraints declared on the container apply to the contained value(s);</p>
          </div>
          <div class="listingblock">
          <div class="content">
          <pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@ConstraintsApplyTo</span>(CONTAINED_VALUES)&#x000A;<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">JavaFXPropertyContainerExtractor</span>&lt;T&gt; <span style="color:#088;font-weight:bold">implements</span> SingleContainerValueExtractor&lt;Property&lt;T&gt;,T&gt; { ... }&#x000A;&#x000A;<span style="color:#777">// test that the age is at least 5</span>&#x000A;<span style="color:#007">@Min</span>(<span style="color:#00D">5</span>) IntegerProperty age;</code></pre>
          </div>
          </div>
          <div class="paragraph">
          <p>This is useful for JavaFX to force the validation of the contained properties.</p>
          </div>
          <div class="paragraph">
          <p>One can also force the constraints to apply to the container or the container value per site</p>
          </div>
          <div class="listingblock">
          <div class="content">
          <pre class="CodeRay highlight"><code data-lang="java"><span style="color:#777">// the list must have 5 elements at least</span>&#x000A;<span style="color:#007">@ConstraintsApplyTo</span>(CONTAINED_VALUES)&#x000A;<span style="color:#007">@Size</span>(min=<span style="color:#00D">5</span>)&#x000A;Optional&lt;<span style="color:#0a8;font-weight:bold">List</span>&lt;<span style="color:#0a8;font-weight:bold">Integer</span>&gt;&gt; ages;&#x000A;&#x000A;<span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">IntegerList</span> <span style="color:#088;font-weight:bold">extends</span> <span style="color:#0a8;font-weight:bold">ArrayList</span>&lt;<span style="color:#0a8;font-weight:bold">Integer</span>&gt; {};&#x000A;&#x000A;<span style="color:#777">// each age must be &gt;= at 2</span>&#x000A;<span style="color:#007">@ConstraintsApplyTo</span>(CONTAINED_VALUES)&#x000A;<span style="color:#007">@Min</span>(<span style="color:#00D">2</span>)&#x000A;IntegerList ages;</code></pre>
          </div>
          </div>
          <div class="paragraph">
          <p>Note that the preferred form is <code>List&lt;@Min(2) Integer&gt; ages;</code>.</p>
          </div>
          <div class="paragraph">
          <p>Here is a scary example</p>
          </div>
          <div class="listingblock">
          <div class="content">
          <pre class="CodeRay highlight"><code data-lang="java"><span style="color:#777">// each integer must be &gt;= at 2</span>&#x000A;<span style="color:#007">@ConstraintsApplyTo</span>(CONTAINED_VALUES)&#x000A;<span style="color:#007">@Min</span>(<span style="color:#00D">2</span>)&#x000A;Optional&lt;<span style="color:#007">@ConstraintsApplyTo</span>(CONTAINED_VALUES) <span style="color:#0a8;font-weight:bold">List</span>&lt;<span style="color:#0a8;font-weight:bold">Integer</span>&gt;&gt; weirdo;</code></pre>
          </div>
          </div>
          <div class="paragraph">
          <p><code>@ConstraintsApplyTo</code> can be applied in type use slots.</p>
          </div>
          <div class="paragraph">
          <p><code>@ConstraintsApplyTo</code> offers a way to define at which level nested container resolution stops (if necessary).
          Not by an explicit depth level but rather by its placement.</p>
          </div>
          <div class="paragraph">
          <p>Let&#8217;s show some more examples for good measure</p>
          </div>
          <div class="listingblock">
          <div class="content">
          <pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@Size</span> Optional&lt;<span style="color:#0a8;font-weight:bold">String</span>&gt; foo; <span style="color:#777">// illegal as @Size does not apply to Optional</span>&#x000A;Optional&lt;<span style="color:#007">@Size</span> <span style="color:#0a8;font-weight:bold">String</span>&gt; foo; <span style="color:#777">// legal as @Size applies to String</span>&#x000A;&#x000A;<span style="color:#007">@Min</span> IntegerProperty foo; <span style="color:#777">// legal because the extractor for JavaFX uses @ConstraintsApplyTo(CONTAINED_VALUES)</span>&#x000A;&#x000A;<span style="color:#007">@Size</span> <span style="color:#0a8;font-weight:bold">Collection</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>&gt; foo;  <span style="color:#777">// The size applies to the collection, not the string since the extractor has the default @ConstraintsApplyTo(CONTAINER) value</span></code></pre>
          </div>
          </div>
          <div class="admonitionblock important">
          <table>
          <tr>
          <td class="icon">
          <i class="fa icon-important" title="Important"></i>
          </td>
          <td class="content">
          TODO: should we offer a per annotation override:
          <code>@NotNull(validAppliedTo=CONTAINED_VALUE)</code>.
          The drawback is that old annotations will have to add the new attribute to offer the option.
          </td>
          </tr>
          </table>
          </div>
          <div class="admonitionblock warning">
          <table>
          <tr>
          <td class="icon">
          <i class="fa icon-warning" title="Warning"></i>
          </td>
          <td class="content">
          <code>@ConstraintsApplyTo</code> can only be used on containers that have a single value type.
          How to differentiate different value types otherwise ?
          </td>
          </tr>
          </table>
          </div>
          <div class="sect3">
          <h4 id="code-valid-code"><a class="anchor" href="#code-valid-code"></a>2.2.1. <code>@Valid</code></h4>
          <div class="paragraph">
          <p>Cascading via <code>@Valid</code> should also honor containers.</p>
          </div>
          <div class="listingblock">
          <div class="content">
          <pre class="CodeRay highlight"><code data-lang="java"><span style="color:#0a8;font-weight:bold">Collection</span>&lt;<span style="color:#007">@Valid</span> PlushGiraffe&gt; giraffes;&#x000A;&#x000A;<span style="color:#007">@Valid</span>&#x000A;<span style="color:#0a8;font-weight:bold">Collection</span>&lt;PlushGiraffe&gt; giraffes</code></pre>
          </div>
          </div>
          <div class="paragraph">
          <p>The first form is the most readable.
          The second form should be supported for backward compatibility reasons for collections and maps</p>
          </div>
          <div class="quoteblock">
          <blockquote>
          <div class="paragraph">
          <p>GM: There is a subtle difference between the two. The first one clearly only applies to the elements of the collection.
          The second though affects elements of the collection (as "hard-coded" into the spec) and any other constraints on properties if the collection is of a specific type such as <code>MyFancyCollection</code>.</p>
          </div>
          </blockquote>
          </div>
          <div class="paragraph">
          <p>Here are the various questions:</p>
          </div>
          <div class="listingblock">
          <div class="content">
          <pre class="CodeRay highlight"><code data-lang="java"><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Foo</span> {&#x000A;   <span style="color:#007">@Valid</span> <span style="color:#777">// cascade all or only the legacy ones? gut feeling is legacy</span>&#x000A;   <span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#007">@RegExp</span>(...) <span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#007">@Min</span>(<span style="color:#00D">4</span>) <span style="color:#0a8;font-weight:bold">Integer</span>&gt; bars;&#x000A;&#x000A;   <span style="color:#777">// clear intent</span>&#x000A;   <span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#007">@Valid</span> <span style="color:#007">@RegExp</span>(...) <span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#007">@Valid</span> <span style="color:#007">@Min</span>(<span style="color:#00D">4</span>) <span style="color:#0a8;font-weight:bold">Integer</span>&gt; bars;&#x000A;&#x000A;   <span style="color:#777">// TODO no place to put the @Valid on the key / value</span>&#x000A;   <span style="color:#777">// so we should support legacy Map and decide what to do on random types</span>&#x000A;   StringIntegerMap bazs;&#x000A;}</code></pre>
          </div>
          </div>
          <div class="admonitionblock important">
          <table>
          <tr>
          <td class="icon">
          <i class="fa icon-important" title="Important"></i>
          </td>
          <td class="content">
          TODO: Find an answer to the <code>@Valid</code> questions
          </td>
          </tr>
          </table>
          </div>
          </div>
          <div class="sect3">
          <h4 id="code-constraintsapplyto-code-value-for-built-in-containers"><a class="anchor" href="#code-constraintsapplyto-code-value-for-built-in-containers"></a>2.2.2. <code>@ConstraintsApplyTo</code> Value for built-in containers</h4>
          <div class="paragraph">
          <p><code>Optional</code> defaults to <code>CONTAINER</code>.
          <code>Iterable</code> and <code>Map</code> default to <code>CONTAINER</code>.
          JavaFX <code>Property&lt;T&gt;</code> defaults to <code>CONTAINED_VALUES</code>.</p>
          </div>
          <div class="paragraph">
          <p>The default for JavaFX property differs
          because in this community the idiom <code>IntegerProperty</code> prevails over <code>Property&lt;Integer&gt;</code>.</p>
          </div>
          </div>
          <div class="sect3">
          <h4 id="complex-type-parameter-hierarchies"><a class="anchor" href="#complex-type-parameter-hierarchies"></a>2.2.3. Complex type parameter hierarchies</h4>
          <div class="paragraph">
          <p>Complex hierarchies involving multiple levels of generic types are not trivial to solve
          and will require the use of <a href="https://github.com/FasterXML/java-classmate">FasterXML&#8217;s Classmate</a>
          or more likely an enhanced version of it.</p>
          </div>
          <div class="listingblock">
          <div class="content">
          <pre class="CodeRay highlight"><code data-lang="java"><span style="color:#339;font-weight:bold">interface</span> <span style="color:#B06;font-weight:bold">Map</span>&lt;K,V&gt; { ... }&#x000A;<span style="color:#777">// type parameter names change between subclass and superclass</span>&#x000A;<span style="color:#777">// and the position can be different between the class and the implements / extends clause</span>&#x000A;<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">CrazyMap</span>&lt;Last, First&gt; <span style="color:#088;font-weight:bold">implements</span> <span style="color:#0a8;font-weight:bold">Map</span>&lt;First, Last&gt; { ... }&#x000A;&#x000A;<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Example</span> {&#x000A;    <span style="color:#777">// String is Map's type parameter V and Long is Map's type parameter K</span>&#x000A;    <span style="color:#088;font-weight:bold">private</span> CrazyMap&lt;<span style="color:#007">@RegExp</span>(...) <span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#007">@Min</span>(<span style="color:#00D">0</span>) <span style="color:#0a8;font-weight:bold">Long</span>&gt; crazyMap = ...;&#x000A;}</code></pre>
          </div>
          </div>
          <div class="paragraph">
          <p>In this situation, we need to follow the (annotated) type parameter across two or more levels up the hierarchy chain.
          Note that type parameter names can vary between the subclass definition and the superclass definition.</p>
          </div>
          <div class="paragraph">
          <p>I&#8217;ve played with Classmate and it does not seem to retain the information in its data even though it solves that problem internally to find the right type.
          We might need to contribute to expose that somehow.</p>
          </div>
          <div class="paragraph">
          <p>Also I don&#8217;t think Classmate exposes annotations on type use, so we would need to contribute that or use something else like Jandex or plain Java reflection API.</p>
          </div>
          </div>
          <div class="sect3">
          <h4 id="alternative-model-not-preferred"><a class="anchor" href="#alternative-model-not-preferred"></a>2.2.4. Alternative model (not preferred)</h4>
          <div class="paragraph">
          <p>If a constraint is valid for specific types (say <code>@Size</code> for <code>Collection</code>, and <code>String</code>),
          it is possible to disambiguate the application of the constraint on the container vs the contained value.
          In particular for JavaFX.</p>
          </div>
          <div class="listingblock">
          <div class="content">
          <pre class="CodeRay highlight"><code data-lang="java"><span style="color:#777">// test that the age is at least 5</span>&#x000A;<span style="color:#777">// since IntegerProperty extends Property which are not supported by Size</span>&#x000A;<span style="color:#777">// but that String is supported for Size</span>&#x000A;<span style="color:#007">@Size</span>(<span style="color:#00D">5</span>) StringProperty&lt;<span style="color:#0a8;font-weight:bold">String</span>&gt; name;</code></pre>
          </div>
          </div>
          <div class="paragraph">
          <p>In case the container and the contained values are both supported by a given constraint,
          <code>@ConstraintsApplyTo</code> becomes mandatory.</p>
          </div>
          <div class="paragraph">
          <p>This model is fully deterministic but:</p>
          </div>
          <div class="ulist">
          <ul>
          <li>
          <p>is hard to grasp and requires advanced knowledge of the constraint validators + containers / contained values to decipher</p>
          </li>
          <li>
          <p>breaks for common constraints like <code>@NotNull</code>, <code>@Size</code>, <code>@Min</code> especially when containers are collections</p>
          </li>
          </ul>
          </div>
          <div class="paragraph">
          <p>I propose not to apply it and use the extractor level <code>@ConstraintsApplyTo(CONTAINED_VALUES)</code> as a solution.</p>
          </div>
          </div>
          </div>
          <div class="sect2">
          <h3 id="type-parameter-and-constraint-propagation"><a class="anchor" href="#type-parameter-and-constraint-propagation"></a>2.3. Type parameter and constraint propagation</h3>
          <div class="listingblock">
          <div class="content">
          <pre class="CodeRay highlight"><code data-lang="java"><span style="color:#777">// @NotNull is applied on a type parameter</span>&#x000A;<span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">CustList</span> <span style="color:#088;font-weight:bold">extends</span> <span style="color:#0a8;font-weight:bold">List</span>&lt;<span style="color:#007">@NotNull</span> Customer&gt; {&#x000A;}</code></pre>
          </div>
          </div>
          <div class="paragraph">
          <p>When and where to apply the not null ? Getters, setters, return types, parameter types?</p>
          </div>
          <div class="listingblock">
          <div class="content">
          <pre class="CodeRay highlight"><code data-lang="java"><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Foo</span>&lt;T&gt; {&#x000A;    T getSome();&#x000A;    <span style="color:#339;font-weight:bold">void</span> setFoo(T t);&#x000A;    T retrieveOther();&#x000A;    <span style="color:#339;font-weight:bold">void</span> processSome(T t);&#x000A;}&#x000A;&#x000A;<span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Bar</span> <span style="color:#088;font-weight:bold">extends</span> Foo&lt;<span style="color:#007">@NotNull</span> <span style="color:#0a8;font-weight:bold">String</span>&gt; {&#x000A;}</code></pre>
          </div>
          </div>
          <div class="paragraph">
          <p>Concern what that does, not obvious?
          Second concern is where is it useful?</p>
          </div>
          <div class="admonitionblock note">
          <table>
          <tr>
          <td class="icon">
          <i class="fa icon-note" title="Note"></i>
          </td>
          <td class="content">
          Proposal: not including this templating feature in the first version of the spec.
          </td>
          </tr>
          </table>
          </div>
          </div>
          <div class="sect2">
          <h3 id="crazy-type-use"><a class="anchor" href="#crazy-type-use"></a>2.4. "Crazy" Type use</h3>
          <div class="paragraph">
          <p>Java 8 annotations can be placed on all type use</p>
          </div>
          <div class="listingblock">
          <div class="content">
          <pre class="CodeRay highlight"><code data-lang="java"><span style="color:#777">// type use</span>&#x000A;<span style="color:#007">@NotNull</span> <span style="color:#0a8;font-weight:bold">String</span> name = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Emmanuel</span><span style="color:#710">&quot;</span></span>;&#x000A;<span style="color:#080;font-weight:bold">new</span> <span style="color:#007">@NonEmpty</span> <span style="color:#007">@Readonly</span> <span style="color:#0a8;font-weight:bold">List</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>&gt;(myNonEmptyStringSet)&#x000A;myString = (<span style="color:#007">@NonNull</span> <span style="color:#0a8;font-weight:bold">String</span>) myObject;&#x000A;<span style="color:#007">@Vernal</span> <span style="color:#0a8;font-weight:bold">Date</span>::getDay</code></pre>
          </div>
          </div>
          <div class="paragraph">
          <p>Type use outside parameterized containers won&#8217;t be used in Bean Validation - at least for now.
          Implementing constraint validation in these general areas would require a very instrumented code
          using a powerful bytecode manipulation engine.
          The implications of the locations annotations is unknown.</p>
          </div>
          </div>
          <div class="sect2">
          <h3 id="drawbacks"><a class="anchor" href="#drawbacks"></a>2.5. Drawbacks</h3>
          <div class="paragraph">
          <p>The logic is less regular than Gunnar&#8217;s proposal.
          And thus could lock us for future enhancements.
          Where? Dunno.</p>
          </div>
          <div class="paragraph">
          <p>But it has less far reaching implications in particular around method validation.</p>
          </div>
          </div>
          <div class="sect2">
          <h3 id="naming-options"><a class="anchor" href="#naming-options"></a>2.6. Naming options</h3>
          <div class="paragraph">
          <p><code>SingleContainerValueExtractor</code>: <code>ValidatedValueUnwrapper</code>, <code>ValueExtractor</code></p>
          </div>
          </div>
          <div class="sect2">
          <h3 id="remaining-todos"><a class="anchor" href="#remaining-todos"></a>2.7. Remaining TODOs</h3>
          <div class="paragraph">
          <p>Should we have a BV 1.1 based logic that forces to use a global <code>@ConstraintsApplyTo(CONTAINER)</code>
          to enforce strict backward compatibility.
          And a BV 2.0 based logic (driven by the XML version?) would have the right ergonomics as described above?</p>
          </div>
          </div>
          </div>
          </div>
          <div class="sect1">
          <h2 id="alternative-proposal-consider-type-constraints-as-instance-specific-amendment-of-constraint-set-gunnar"><a class="anchor" href="#alternative-proposal-consider-type-constraints-as-instance-specific-amendment-of-constraint-set-gunnar"></a>3. Alternative proposal: Consider type-constraints as instance-specific amendment of constraint set (Gunnar)</h2>
          <div class="sectionbody">
          <div class="paragraph">
          <p><strong>TL,DR</strong> The two proposals have converged more or less in the course of the discussion;
          Essentially this proposal is a generalization of the more explicit approach which considers specific container types (lists, maps etc.) only.
          Instead of supporting only some explicitly "known" container types, this proposal seeks to generalize that for any generic container type, e.g. a custom <code>Tuple</code> type.</p>
          </div>
          <div class="paragraph">
          <p>Admittedly, the number of such container types is rather limited and we cover the largest part by the spec&#8217;ed support for list et al. in the other proposal.
          And cases like Tuple could be addressed by a custom extractor.
          So I&#8217;d be fine without this feature, as most cases are covered by default and we are extensible for others; We still could spec such generalization later on if we think it makes sense.</p>
          </div>
          <div class="sect2">
          <h3 id="motivation"><a class="anchor" href="#motivation"></a>3.1. Motivation</h3>
          <div class="paragraph">
          <p>Currently, constraint meta-data is fixed for a given type by annotating the type&#8217;s class definition or configuring it in XML.
          This proposal allows to amend that statically defined constraint meta-data with instance-specific meta-data applied to generic parameters declared by the type.</p>
          </div>
          <div class="paragraph">
          <p>Example:</p>
          </div>
          <div class="listingblock">
          <div class="content">
          <pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Tuple</span>&lt;V1, V2&gt; {&#x000A;&#x000A;    <span style="color:#007">@NotNull</span>&#x000A;    <span style="color:#088;font-weight:bold">private</span> V1 v1;&#x000A;&#x000A;    <span style="color:#007">@NotNull</span>&#x000A;    <span style="color:#088;font-weight:bold">private</span> V2 v2;&#x000A;&#x000A;    <span style="color:#088;font-weight:bold">public</span> V1 getV1() { <span style="color:#080;font-weight:bold">return</span> v1; }&#x000A;    <span style="color:#088;font-weight:bold">public</span> V2 getV2() { <span style="color:#080;font-weight:bold">return</span> v2; }&#x000A;}&#x000A;&#x000A;<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">User</span> {&#x000A;&#x000A;    <span style="color:#007">@Valid</span>&#x000A;    <span style="color:#088;font-weight:bold">private</span> Tuple&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#007">@Min</span>(<span style="color:#00D">1</span>) <span style="color:#0a8;font-weight:bold">Integer</span>&gt; nameAndAge = ...;&#x000A;}</code></pre>
          </div>
          </div>
          <div class="paragraph">
          <p>Calling <code>Validator#validate( new Tuple(&#8230;&#8203;) )</code> will validate the <code>@NotNull</code> constraints statically declared in the <code>Tuple</code> class.
          Calling <code>Validator#validate( new User(&#8230;&#8203;) )</code> will validate the <code>@NotNull</code> constraints <strong>and</strong> the instance-specific <code>@Min</code> constraint given for the <code>V2</code> type parameter.</p>
          </div>
          <div class="admonitionblock important">
          <table>
          <tr>
          <td class="icon">
          <i class="fa icon-important" title="Important"></i>
          </td>
          <td class="content">
          <div class="title">How to obtain the property value, getter vs. field access?</div>
          <div class="paragraph">
          <p>Iterate all getters and apply the constraint to all those matching the annotated type (V2); Then iterate all fields and apply to all those matching the annotated type and where no getter for that property has been validated in the first step. I.e. prefer getter over field access.</p>
          </div>
          </td>
          </tr>
          </table>
          </div>
          </div>
          <div class="sect2">
          <h3 id="constraints-of-collection-elements"><a class="anchor" href="#constraints-of-collection-elements"></a>3.2. Constraints of collection elements</h3>
          <div class="paragraph">
          <p>This proposal makes the case of constraints on collection elements (list etc.) very regular.</p>
          </div>
          <div class="paragraph">
          <p>Example:</p>
          </div>
          <div class="listingblock">
          <div class="content">
          <pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@ValidAddress</span>&#x000A;<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Address</span> {}&#x000A;&#x000A;<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">User</span> {&#x000A;&#x000A;    <span style="color:#007">@Valid</span>&#x000A;    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">List</span>&lt;<span style="color:#007">@Exists</span> Address&gt; addresses;&#x000A;}</code></pre>
          </div>
          </div>
          <div class="paragraph">
          <p>This adds the <code>@Exists</code> constraint to constraint metadata for <code>&lt;T&gt;</code> of the <code>addresses</code> list (i.e. in addition to the statically defined <code>@ValidAddress</code> ).
          When validating a <code>User</code>, the engine will access <code>&lt;T&gt;</code> during cascaded validation (by invoking <code>List#getIterator()</code> or similar).
          Then both constraints, <code>@Exists</code> and <code>@ValidAddress</code> will be applied.</p>
          </div>
          <div class="paragraph">
          <p>This avoids any assumptions about the type parameter of the collection instance.
          Specifically, it&#8217;s not guaranteed that the type parameter of the instance actually represents the one we might think (e.g. <code>&lt;T&gt;</code> of <code>List</code>):</p>
          </div>
          <div class="listingblock">
          <div class="content">
          <pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">interface</span> <span style="color:#B06;font-weight:bold">IdentifiedStringList</span>&lt;I&gt; <span style="color:#088;font-weight:bold">extends</span> <span style="color:#0a8;font-weight:bold">List</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>&gt; {&#x000A;    I getIdentifier();&#x000A;}&#x000A;&#x000A;<span style="color:#007">@Valid</span>&#x000A;<span style="color:#088;font-weight:bold">private</span> IdentifiedStringList&lt;<span style="color:#007">@Min</span>(<span style="color:#00D">1</span>) <span style="color:#0a8;font-weight:bold">Long</span>&gt; myLongIdentifiedStringList = ...;</code></pre>
          </div>
          </div>
          <div class="paragraph">
          <p>Here the <code>@Min</code> constraint must not be applied to the collection elements as it doesn&#8217;t relate to <code>&lt;T&gt;</code> of <code>List</code> but <code>&lt;I&gt;</code> of <code>IdentifiedStringList</code>.</p>
          </div>
          </div>
          <div class="sect2">
          <h3 id="obtaining-values-from-containers"><a class="anchor" href="#obtaining-values-from-containers"></a>3.3. Obtaining values from containers</h3>
          <div class="paragraph">
          <p>Currently cascaded validation applies to bean references and collections (<code>Collection</code>, <code>Map</code>, arrays).
          This proposal suggests to open that up, allowing to provide support for other cascadable types, e.g. <code>Optional</code>:</p>
          </div>
          <div class="listingblock">
          <div class="content">
          <pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@Valid</span>&#x000A;<span style="color:#088;font-weight:bold">private</span> Optional&lt;<span style="color:#007">@Size</span>(max=<span style="color:#00D">20</span>) <span style="color:#0a8;font-weight:bold">String</span>&gt; name;</code></pre>
          </div>
          </div>
          <div class="paragraph">
          <p>When encountering <code>@Valid</code>, we&#8217;ll look for matching extractor implementations.
          See Emmanuel&#8217;s original proposal and my alternative above for extractor contracts.</p>
          </div>
          <div class="paragraph">
          <p>A conforming implementation provides out-of-the-box extractor implementations for bean references (used by default) and collections.</p>
          </div>
          <div class="paragraph">
          <p>Representing the <code>Optional</code> case in this generic fashion is nice, but two shortcomings need to be addressed:</p>
          </div>
          <div class="ulist">
          <ul>
          <li>
          <p>There should be no element in the constraint violation path for the wrapped element, only the container itself (this depends on the container type; For <code>Optional</code>, suppressing makes sense, but for <code>List</code> not)</p>
          </li>
          <li>
          <p>The explicitly required <code>@Valid</code> makes it more verbose</p>
          </li>
          </ul>
          </div>
          <div class="paragraph">
          <p>This could be mitigated by letting value extractors make this configurable:</p>
          </div>
          <div class="listingblock">
          <div class="content">
          <pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">interface</span> <span style="color:#B06;font-weight:bold">ValueExtractor</span> {&#x000A;    <span style="color:#339;font-weight:bold">boolean</span> addPathNodeForExtractedValue();&#x000A;    <span style="color:#339;font-weight:bold">boolean</span> autoApply();&#x000A;}&#x000A;&#x000A;<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">OptionalValueExtractor</span>&lt;T&gt; <span style="color:#088;font-weight:bold">implements</span> SingleValueExtractor&lt;Optional&lt;T&gt;, T&gt; {&#x000A;    T extractValue(Optional&lt;T&gt; optional) {&#x000A;        <span style="color:#080;font-weight:bold">return</span> optional.get();&#x000A;    }&#x000A;&#x000A;    <span style="color:#339;font-weight:bold">boolean</span> addPathNodeForExtractedValue() {&#x000A;        <span style="color:#080;font-weight:bold">return</span> <span style="color:#069">false</span>;&#x000A;    }&#x000A;&#x000A;    <span style="color:#339;font-weight:bold">boolean</span> autoApply() {&#x000A;        <span style="color:#080;font-weight:bold">return</span> <span style="color:#069">true</span>;&#x000A;    }&#x000A;}</code></pre>
          </div>
          </div>
          <div class="paragraph">
          <p>That way, previous example could look like so, i.e. without <code>@Valid</code>:</p>
          </div>
          <div class="listingblock">
          <div class="content">
          <pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">private</span> Optional&lt;<span style="color:#007">@Size</span>(max=<span style="color:#00D">20</span>) <span style="color:#0a8;font-weight:bold">String</span>&gt; name;</code></pre>
          </div>
          </div>
          <div class="sect3">
          <h4 id="alternative-for-valid-suggested-by-emmanuel"><a class="anchor" href="#alternative-for-valid-suggested-by-emmanuel"></a>3.3.1. Alternative for @Valid suggested by Emmanuel</h4>
          <div class="paragraph">
          <p>If a member, parameter or return value declaration presents an annotated type use, then <code>@Valid</code> is implied for that declaration. @Valid is permitted but redundant in this case.</p>
          </div>
          <div class="listingblock">
          <div class="content">
          <pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Foo</span> {&#x000A;    Bar&lt;<span style="color:#007">@NotNull</span> Baz&gt; baz;&#x000A;    <span style="color:#777">// equivalent to</span>&#x000A;    <span style="color:#007">@Valid</span>&#x000A;    Bar&lt;<span style="color:#007">@NotNull</span> Baz&gt; baz2;&#x000A;}&#x000A;&#x000A;<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Foo</span> {&#x000A;    <span style="color:#007">@Valid</span> <span style="color:#777">//optional</span>&#x000A;    Buz&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#007">@Min</span>(<span style="color:#00D">5</span>) <span style="color:#0a8;font-weight:bold">Integer</span>&gt; num;&#x000A;&#x000A;    <span style="color:#777">// validates Buz as there is an optional @Valid here</span>&#x000A;    <span style="color:#777">// inside Buz, cascade validation to @Foo</span>&#x000A;    Buz&lt;<span style="color:#007">@Valid</span> Foo, <span style="color:#0a8;font-weight:bold">Integer</span>&gt; num;&#x000A;}</code></pre>
          </div>
          </div>
          <div class="paragraph">
          <p>Note that this model, while regular, is not the behavior of Collection and Map:</p>
          </div>
          <div class="ulist">
          <ul>
          <li>
          <p><code>@Valid Collection&lt;Foo&gt;</code> is equivalent to <code>@Valid Collection&lt;@Valid Foo&gt;</code></p>
          </li>
          <li>
          <p><code>@Valid Map&lt;Foo, Bar&gt;</code> is equivalent to <code>@Valid Collection&lt;Foo, @Valid Bar&gt;</code></p>
          </li>
          </ul>
          </div>
          <div class="admonitionblock important">
          <table>
          <tr>
          <td class="icon">
          <i class="fa icon-important" title="Important"></i>
          </td>
          <td class="content">
          <div class="title">TODO</div>
          <div class="paragraph">
          <p>Should we consider the former form as legacy and deprecated?</p>
          </div>
          <div class="ulist">
          <ul>
          <li>
          <p>New code would write it as <code>Collection&lt;@Valid Foo&gt;</code> or <code>@Valid Collection&lt;@Valid Foo&gt;</code> for the verbose.</p>
          </li>
          <li>
          <p>New code would write it as <code>Map&lt;Foo, @Valid Bar&gt;</code> or @Valid Collection&lt;@Valid Foo&gt;` for the verbose.</p>
          </li>
          <li>
          <p>What should <code>@Valid Map&lt;@Valid Foo, Bar&gt;</code> do ?</p>
          </li>
          <li>
          <p>How to disable that implicit <code>@Valid</code>, e.g. if I don&#8217;t want cascaded validation of <code>Bar&lt;@NotNull Baz&gt; baz</code>?</p>
          </li>
          </ul>
          </div>
          </td>
          </tr>
          </table>
          </div>
          </div>
          <div class="sect3">
          <h4 id="miscellaneous"><a class="anchor" href="#miscellaneous"></a>3.3.2. Miscellaneous</h4>
          <div class="paragraph">
          <p><strong>Explicitly not supported:</strong> Applying constraints to container types with the intention of targeting the wrapped value.
          I.e. the following would not work:</p>
          </div>
          <div class="listingblock">
          <div class="content">
          <pre class="CodeRay highlight"><code data-lang="java"><span style="color:#777">// No validator for @Size+String</span>&#x000A;<span style="color:#007">@Size</span>(max=<span style="color:#00D">20</span>)&#x000A;<span style="color:#088;font-weight:bold">private</span> Optional&lt;<span style="color:#0a8;font-weight:bold">String</span>&gt; name;</code></pre>
          </div>
          </div>
          <div class="paragraph">
          <p>Maybe that&#8217;s ok, as in most cases there will be a type parameter. For JavaFX with its types such as <code>IntegerProperty</code> we could require compatible implementations to provide the required validator implementions e.g. for <code>@Min</code> + <code>IntegerProperty</code>. Or we ignore that, I&#8217;ve never heard of demand.</p>
          </div>
          <div class="admonitionblock important">
          <table>
          <tr>
          <td class="icon">
          <i class="fa icon-important" title="Important"></i>
          </td>
          <td class="content">
          TODO: Gauge demand for JavaFX support
          </td>
          </tr>
          </table>
          </div>
          </div>
          <div class="sect3">
          <h4 id="questions-to-address"><a class="anchor" href="#questions-to-address"></a>3.3.3. Questions to address</h4>
          <div class="ulist">
          <ul>
          <li>
          <p>does not propagate to method validation (i.e not on type parameter in the definition)</p>
          </li>
          <li>
          <p>getter vs field issue</p>
          </li>
          <li>
          <p>Look of constraint on type use of all types to avoid <code>@Valid</code></p>
          </li>
          <li>
          <p>use dynamic constraint declaration when no extractor exists, use the extractor otherwise</p>
          <div class="ulist">
          <ul>
          <li>
          <p>all or nothing? i.e. use both? Probably confusing
          but what about</p>
          </li>
          </ul>
          </div>
          </li>
          </ul>
          </div>
          <div class="listingblock">
          <div class="content">
          <pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">interface</span> <span style="color:#B06;font-weight:bold">IdentifiedStringList</span>&lt;I&gt; <span style="color:#088;font-weight:bold">extends</span> <span style="color:#0a8;font-weight:bold">List</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>&gt; {&#x000A;    I getIdentifier();&#x000A;}&#x000A;And its usage:&#x000A;&#x000A;<span style="color:#007">@Valid</span>&#x000A;<span style="color:#088;font-weight:bold">private</span> IdentifiedStringList&lt;<span style="color:#007">@Min</span>(<span style="color:#00D">1</span>) <span style="color:#0a8;font-weight:bold">Long</span>&gt; myLongIdentifiedStringList = ...;</code></pre>
          </div>
          </div>
          <div class="paragraph">
          <p>I guess it needs an extractor</p>
          </div>
          <div class="ulist">
          <ul>
          <li>
          <p>if collection is to ue generic proposal, clarify how: as both, extractor first?</p>
          </li>
          </ul>
          </div>
          </div>
          </div>
          </div>
          </div>
          <div class="sect1">
          <h2 id="attic"><a class="anchor" href="#attic"></a>4. Attic</h2>
          <div class="sectionbody">
          <div class="sect2">
          <h3 id="type-use-annotations-vs-enlisting-unwrapping-logic"><a class="anchor" href="#type-use-annotations-vs-enlisting-unwrapping-logic"></a>4.1. Type use annotations vs enlisting unwrapping logic</h3>
          <div class="paragraph">
          <p>Type use located annotations open opportunity to express the constraints elegantly.</p>
          </div>
          <div class="listingblock">
          <div class="content">
          <pre class="CodeRay highlight"><code data-lang="java"><span style="color:#777">// Collection of non null Strings</span>&#x000A;<span style="color:#0a8;font-weight:bold">Collection</span>&lt;<span style="color:#007">@NotNull</span> <span style="color:#0a8;font-weight:bold">String</span>&gt; names;</code></pre>
          </div>
          </div>
          <div class="paragraph">
          <p>Note however that this does not work if the constraint is applied on a subtype of the parameterized type.</p>
          </div>
          <div class="listingblock">
          <div class="content">
          <pre class="CodeRay highlight"><code data-lang="java"><span style="color:#777">// this works</span>&#x000A;<span style="color:#0a8;font-weight:bold">Collection</span>&lt;<span style="color:#007">@NotNull</span> <span style="color:#0a8;font-weight:bold">String</span>&gt; names;&#x000A;&#x000A;<span style="color:#088;font-weight:bold">public</span> StringCollection <span style="color:#088;font-weight:bold">extends</span> <span style="color:#0a8;font-weight:bold">Collection</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>&gt; {&#x000A;}&#x000A;&#x000A;<span style="color:#777">// Where to put the @NotNull?</span>&#x000A;StringCollection names;</code></pre>
          </div>
          </div>
          <div class="paragraph">
          <p>For the latter, one option is to enlist an explicit unwrapper (see <a href="http://docs.jboss.org/hibernate/validator/5.2/reference/en-US/html_single/#section-value-handling">Hibernate Validator&#8217;s feature</a>).
          An unwrapper will apply some unwrapping logic for well known types.
          It needs to be registered globally (<code>ValidatorFactory</code> or service locator based).
          For unwrapped properties would consider the annotations hosted on the wrapper</p>
          </div>
          <div class="listingblock">
          <div class="content">
          <pre class="CodeRay highlight"><code data-lang="java"><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">StringCollectionUnwrapper</span> <span style="color:#088;font-weight:bold">implements</span> ValidatedValueUnwrapper&lt;StringCollection&gt; { ... }&#x000A;&#x000A;<span style="color:#007">@NotNull</span> <span style="color:#777">//applied on the elements of the collection</span>&#x000A;StringCollection names;</code></pre>
          </div>
          </div>
          <div class="admonitionblock important">
          <table>
          <tr>
          <td class="icon">
          <i class="fa icon-important" title="Important"></i>
          </td>
          <td class="content">
          <div class="title">TODO What to do about nested unwrappers?</div>
          <div class="paragraph">
          <p>Go to the deepest?
          What to validate for: <code>@Min(23)</code> <code>List&lt;IntegerProperty&gt; bar</code>? <code>List</code> vs. <code>IntegerProperty</code> vs. wrapped <code>Integer</code>?
          What about <code>Optional&lt;Optional&lt;String&gt;&gt;</code>? Should we unwrap recursively?</p>
          </div>
          </td>
          </tr>
          </table>
          </div>
          </div>
          <div class="sect2">
          <h3 id="generic-mechanism-vs-special-cases"><a class="anchor" href="#generic-mechanism-vs-special-cases"></a>4.2. Generic mechanism vs special cases</h3>
          <div class="paragraph">
          <p>Should collections, optional, javafx properties be all handled by a unified model
          or should they be specific?</p>
          </div>
          </div>
          <div class="sect2">
          <h3 id="generic-container-notion"><a class="anchor" href="#generic-container-notion"></a>4.3. Generic container notion</h3>
          <div class="paragraph">
          <p>Offer a service provider offering a way to consider and navigate the element(s) of a container.
          Container, Optional and Property will be provided as is but other container can be generalized.</p>
          </div>
          <div class="paragraph">
          <p>BTW: Container can be anything Iterable.</p>
          </div>
          </div>
          </div>
          </div>
          <hr>
          
                      <div id="disqus_thread"></div>
                      <script type="text/javascript">
                      var disqus_shortname = 'beanvalidation';
                      var disqus_url = "http://beanvalidation.org/proposals/BVAL-508/";
                      var disqus_developer = null;
                      var disqus_identifier = null;
                      (function() {
                        var dsq = document.createElement("script"); dsq.type = "text/javascript"; dsq.async = true;
                        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName("head")[0] || document.getElementsByTagName("body")[0]).appendChild(dsq);
                      })();
                      </script>
                      <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=beanvalidation">comments powered by Disqus.</a></noscript>
        </div>
      </div>
      <footer class="print hidden">
        <div class="ui inverted vertical footer segment">
          <div class="ui container">
            <div class="ui stackable grid">
              <div class="eleven wide column middle aligned">
                Copyright &copy; Red Hat, Inc.
              </div>
              <div class="five wide column sponsor">
                <div class="logo">
                  <a href="https://www.redhat.com/">
                    <img height="48" src="/images/redhat.png" title="Red Hat" width="150">
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </footer>
    </div>
    <script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
     
    ga('create', 'UA-24703879-1', 'auto');
    ga('send', 'pageview');
    
    </script>
    <script>
      $(document).ready(function() {
        $('#mobile-menu').sidebar('setting', {
          transition: 'push'
        });
        $('#mobile-menu').sidebar('attach events', '#mobile-menu-toggle');
      
        $('.ui.menu .ui.dropdown').dropdown({ on: 'hover' });
      });
    </script>
  </body>
</html>
